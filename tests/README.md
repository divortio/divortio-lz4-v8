
# LZ4-Divortio Test Suite

This directory contains the comprehensive test suite for `lz4-divortio`, verifying correctness, compliance, and performance against reference implementations.

## Compliance & Verification

This library is strictly verified against the **LZ4 Frame Format (1.6.1)** specification and interoperability with reference implementations is proven through cross-validation.

### Proving Interoperability
We validate `lz4-divortio` directly against the official C and Rust libraries:

1.  **Golden Reference Files (C Library)**
    *   **Proof:** [compliance/golden.test.js](compliance/golden.test.js)
    *   **Methodology:** We verify that our decoder correctly handles valid LZ4 files generated by the official [`lz4` CLI](https://github.com/lz4/lz4). This ensures bit-exact compatibility with the reference implementation.

2.  **Regression Porting (Rust Library)**
    *   **Proof:** [reference/rust_regressions.test.js](reference/rust_regressions.test.js)
    *   **Methodology:** We have ported specific regression test cases ("bug_fuzz" byte sequences) from the [`lz4_flex` Rust library](https://github.com/PSeitz/lz4_flex). This guarantees our decoder survives known edge cases that historically broke other implementations.

3.  **Algorithmic Fuzzing (C Library)**
    *   **Proof:** [reference/c_fuzz.test.js](reference/c_fuzz.test.js)
    *   **Methodology:** We implemented the "Compressible Noise" generation logic from the reference `frametest.c`. This stresses the compression engine with statistically randomized data to prove round-trip stability.

### Specification Adherence
Our implementation explicitly supports the full feature set of [LZ4 Frame Format 1.6.1](https://github.com/lz4/lz4/blob/dev/doc/lz4_Frame_format.md):
*   **Frame Descriptors:** Full parsing of Version, Block Independence, and Content Size flags.
*   **Safety Checksums:** proper implementation of `xxHash32` for **Header Checksums**, **Block Checksums**, and **Content Checksums**.
*   **Skippable Frames:** Correct handling (skipping) of User Data frames (`0x184D2A50` - `0x184D2A5F`).

## Execution

Run all tests using the bundled runner:
```bash
node tests/runALL.test.js
```

Target specific directories:
```bash
node tests/runALL.test.js tests/reference/
```

## Test Index

### Block Level
Tests for low-level compression/decompression of single LZ4 blocks.
**Source:** [`src/block/`](../src/block/)
- [blockCompress.test.js](block/blockCompress.test.js) - Basic block compression logic.
- [blockDecompress.test.js](block/blockDecompress.test.js) - Block decompression and malformed input handling.

### Buffer & Frame Level
Tests for complete LZ4 Frame format handling (Header, Content, Footer).
**Source:** [`src/buffer/`](../src/buffer/)
- [bufferCompress.test.js](buffer/bufferCompress.test.js) - Frame compression with headers/checksums.
- [bufferDecompress.test.js](buffer/bufferDecompress.test.js) - Frame decompression and structure validation.

### CLI
Tests for command-line interface behavior.
**Source:** [`src/cli/`](../src/cli/)
- [cliArgs.test.js](cli/cliArgs.test.js) - Argument parsing, flags, and I/O handling.

### Compliance
Tests ensuring adherence to LZ4 specifications.
**Source:** [`src/lz4.js`](../src/lz4.js)
- [golden.test.js](compliance/golden.test.js) - Validates against "Golden Files" generated by reference `lz4` CLI.
- [negative.test.js](compliance/negative.test.js) - Error handling for malformed/corrupted inputs (Magic Number, Checksums).

### Dictionary
Tests for dictionary-based compression support.
**Source:** [`src/dictionary/`](../src/dictionary/)
- [LZ4Dictionary.test.js](dictionary/LZ4Dictionary.test.js) - Dictionary creation and loading.

### Frame Internals
Tests for internal frame components.
**Source:** [`src/frame/`](../src/frame/)
- [frameHeader.test.js](frame/frameHeader.test.js) - Header Descriptor parsing and writing.

### Integration
High-level integration tests for library entry points.
**Source:** [`src/lz4.js`](../src/lz4.js)
- [lz4.test.js](integration/lz4.test.js) - Main `LZ4` object exports and round-trip integration.

### Reference Alignment
Ported tests from reference implementations (C and Rust) to ensure parity.
**Reference:** [`reference/lz4/lz4/tests`](../reference/lz4/lz4/tests), [`reference/PSeitz/lz4_flex/tests`](../reference/PSeitz/lz4_flex/tests)
- [c_fuzz.test.js](reference/c_fuzz.test.js) - "Compressible Noise" fuzzing logic from C `frametest.c`.
- [rust_regressions.test.js](reference/rust_regressions.test.js) - "Bug Fuzz" regression cases from Rust `lz4_flex`.
- [dictionary.test.js](reference/dictionary.test.js) - Reference dictionary logic patterns.

### Shared & Utils
Tests for internal utilities and helpers.
**Source:** [`src/shared/`](../src/shared/), [`src/utils/`](../src/utils/)
- [lz4Decode.test.js](shared/lz4Decode.test.js) - Low-level token decoding.
- [lz4Encode.test.js](shared/lz4Encode.test.js) - Low-level matching/encoding.
- [typeHandling.test.js](shared/typeHandling.test.js) - String/Object wrapper helpers.
- [byteUtils.test.js](utils/byteUtils.test.js) - Byte manipulation helpers.

### Streams
Tests for Node.js Streaming API.
**Source:** [`src/stream/`](../src/stream/)
- [streamCompress.test.js](stream/streamCompress.test.js) - `Transfer-Encoding: chunked` style streaming compression.

### xxHash32
Tests for checksum algorithm validation.
**Source:** [`src/xxhash32/`](../src/xxhash32/)
- [xxhash32.test.js](xxhash32/xxhash32.test.js) - Hash correctness against known vectors.
